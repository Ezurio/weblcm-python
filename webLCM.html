<!DOCTYPE html>
<!--
  Copyright (c) 2017-2020, Laird
  Permission to use, copy, modify, and/or distribute this software for any
  purpose with or without fee is hereby granted, provided that the above
  copyright notice and this permission notice appear in all copies.
  THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
  REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
  AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
  INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
  LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
  OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
  PERFORMANCE OF THIS SOFTWARE.

  Contact: support@lairdconnect.com
-->
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
		<meta name="description" content="">
		<meta name="author" content="">

		<title>WebLCM</title>

		<!-- Bootstrap core CSS -->
		<link href="assets/css/bootstrap.min.css" rel="stylesheet">

		<link href="assets/css/jquery.dataTables.min.css" rel="stylesheet">
		<link href="assets/css/dataTables.bootstrap.min.css" rel="stylesheet">
		<!-- Custom styles -->
		<link href="assets/css/custom.min.css" rel="stylesheet">

		<script src="assets/js/jquery.min.js"></script>
		<script src="assets/js/bootstrap.bundle.min.js"></script>
		<script src="assets/js/jquery.dataTables.min.js"></script>
		<script src="assets/js/dataTables.bootstrap.min.js"></script>
		<script src="assets/js/dataTables.buttons.min.js"></script>
		<script src="assets/js/jquery.i18n.properties.min.js"></script>



		<script>

		var defines;
		var i18nData;
		var currUserPermission;
		var currUser;

		function consoleLog(message){
			console.log(message);
		}

		function httpErrorResponseHandler(xhr, textStatus, errorThrown){
			switch(xhr.status) {
				//HTTP 401 Unauthorized Error
				case 401:
					logout();
					break;
				default:
					consoleLog("HTTP Error: " + xhr.status);
					break;
			}
		}

		function loadjscssfile(key, filetype){
			let jsPath = "plugins/" + key + "/" + key + "." + filetype;
			if (filetype == "js"){

				let fileref = document.createElement('script');

				fileref.setAttribute("type","text/javascript");
				fileref.setAttribute("src", jsPath);
				fileref.onload = function(){
					window[key + "AUTORUN"](0);
				}

				document.getElementsByTagName("head")[0].appendChild(fileref);
			}
		}

		//TBD: HTMLs should be loaded per user
		function weblcm_init(){
			let i, lang;
			let plugins = ["networking", "logging", "swupdate", "usermanage", "advanced", "datetime"];

			for (i = 0; i < plugins.length; i++){
				loadjscssfile(plugins[i], "js");
			}

			lang = window.navigator.userLanguage || window.navigator.language;
			if(lang == "zh" || lang == "zh-CN"){
				$("#language").val("zh-CN");
			}
			else {
				$("#language").val("en");
			}
			$("#language").change()
		}

		function clearReturnData(){
			if($("#alert-msg-main-subdiv").length)
				$("#alert-msg-main-subdiv").remove();
			if($("#alert-msg-mini-subdiv").length)
				$("#alert-msg-mini-subdiv").remove();
		}

		function setReturnData(alerttype, message){
			$("#alert-msg-main").append('<div id="alert-msg-main-subdiv" class="alert ' + alerttype + '"><a class="close" data-dismiss="alert">×</a><span>' + message + '</span></div>')
			$("#alert-msg-mini").append('<div id="alert-msg-mini-subdiv" class="alert ' + alerttype + '"><a class="close" data-dismiss="alert">×</a><span>'+message + '</span></div>')
		}

		function CustomMsg(message, err){

			clearReturnData()

			if(err){
				setReturnData("alert-danger", i18nData[message]? i18nData[message]:message);
			}
			else{
				setReturnData("alert-success", i18nData[message]? i18nData[message]:message);
			}
		}

		function SDCERRtoString(SDCERR){

			clearReturnData()

			switch(parseInt(SDCERR)) {
				case defines.SDCERR.SDCERR_SUCCESS:
					setReturnData("alert-success", i18nData['Success']? i18nData['Success']:"Success");
					break;
				case defines.SDCERR.SDCERR_FAIL:
					setReturnData("alert-danger", i18nData['Failure']? i18nData['Failure']:"Failure");
					break;
				default:
					setReturnData("alert-danger", i18nData['Unknown Data']? i18nData['Unknown Data']:"Unknown Data");
					break;
			}
		}

		function enterKeyPress(e){
			if(e.keyCode === 13){ //enter key
				e.preventDefault();
				login();
			}
		}

		function login(user, passwd){
			var creds = {
				username: $("#username").val(),
				password: $("#password").val(),
			}

			if (user != undefined) {
				creds.username = user;
			}

			if (passwd != undefined) {
				creds.password = passwd;
			}
			// Clear any old return code message
			clearReturnData()

			$.ajax({
				url: "login",
				data: JSON.stringify(creds),
				type: "POST",
				contentType: "application/json",
			})
			.done(function( data ) {
				if (data.SDCERR == defines.SDCERR.SDCERR_SUCCESS){
					$("#loggin").addClass("d-none");
					$("#loggout").removeClass("d-none");

					clearReturnData();

					currUser = creds.username;
					currUserPermission = data.PERMISSION;

					if (data.REDIRECT == 1){
						$("#networking_main_menu").addClass("d-none");
						$("#networking_mini_menu").addClass("d-none");
						clickUpdatePassword();
					}
					else{
						const MENU_ID_TYPE_OFFSET = 10; //"_main_menu"
						$(".locked").each(function() {
							let id = $(this).attr('id');
							if (-1 !== currUserPermission.indexOf(id.slice(0, id.length - MENU_ID_TYPE_OFFSET))){
								$(this).removeClass("d-none");
							}
						});
						$("#networking_main_menu").removeClass("d-none");
						$("#networking_mini_menu").removeClass("d-none");
						$("#usermanage_main_menu").removeClass("d-none");
						$("#usermanage_mini_menu").removeClass("d-none");
						clickStatusPage();
					}
				} else {
					switch(data.SDCERR)
					{
						case defines.SDCERR.SDCERR_USER_LOGGED:
							CustomMsg("User is already logged in", true);
							break;
						case defines.SDCERR.SDCERR_USER_BLOCKED:
							CustomMsg("User is temporarily blocked", true);
							break;
						case defines.SDCERR.SDCERR_FAIL:
						default:
							CustomMsg("Credentials are invalid", true);
							break;
					}
				}
				$("#username").val("");
				$("#password").val("");
			})
			.fail(function(data) {
				consoleLog("Error, couldn't get login.. retrying");
			});
		}

		function logout(){
			$.ajax({
				url: "login",
				data: {},
				type: "DELETE",
				contentType: "application/json",
			})
			.always(function( data ) {
				$("#loggout").addClass("d-none");
				$("#loggin").removeClass("d-none");
				$(".locked").addClass("d-none");
				location.reload();
				clickStatusPage();
			});
		}

		$(document).ready(function() {
			$.ajax({
				url: "definitions",
				type: "GET",
				cache: false,
				contentType: "application/json",
			})
			.done(function( data ) {
				defines = data;
				weblcm_init();
			});
		});

		function setLanguage (id) {
			$("#" + id + " .i18n").each(function () {
				value = $(this).attr('name')
				if(this.tagName.toLowerCase() === 'input') {
					if( $(this).attr("placeholder")) {
						$(this).attr("placeholder", i18nData[value]);
					}
					if($(this).attr("value")){
						$(this).attr("value",i18nData[value]);
					}
				} else if (this.tagName.toLowerCase() === 'option'){
					if($(this).text()){
						$(this).text(i18nData[value]);
					}
				} else {
					$(this).html(i18nData[value]);
				}
			});
		}

		function onChangeLanguageType(){
			lang = $("#language").val()
			$.ajax({
				url:'assets/i18n/'+lang+'.json',
				dataType:'json',
				success:function (data) {
					i18nData = data
					setLanguage("main_menu");
					setLanguage("navbar_menu");
					setLanguage("main_section");
					setLanguage("help_section");
				}
			});
		}

		</script>
	</head>

	<body>

		<nav class="navbar navbar-expand-md navbar-dark bg-dark">
			<a class="navbar-brand" href="#">WebLCM</a>
			<div class="d-md-none">
				<div id="alert-msg-mini" ></div>
			</div>
			<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar_menu" aria-controls="navbar_menu" aria-expanded="false" aria-label="Navigation">
				<span class="navbar-toggler-icon"></span>
			</button>
			<div class="collapse navbar-collapse flex-grow-0 ml-auto" id="navbar_menu">
				<form id="loggin" class="form-inline">
					<input type="text" id="username" name="Username" placeholder="Username" class="form-control mx-1 i18n">
					<input type="password" id="password" name="Password" placeholder="Password" class="form-control mx-1 i18n" onkeypress="enterKeyPress(event)">
					<a type="button" onclick="login()" class="btn btn-light mx-1 i18n" href="#" name="Sign in">Sign in</a>
					<select class="form-control mx-1" id="language" onchange="onChangeLanguageType()">
						<option value="en" default>English</option>
						<option value="zh-CN">中文简体</option>
					</select>
				</form>
				<form id="loggout" class="form-inline d-none">
					<a type="button" onclick="logout()" class="btn btn-light i18n" name= "Log out" href="#">Log out</a>
				</form>
				<ul class="d-md-none float-right">
					<ul class="navbar-nav" id="mini_menu">
						<li id="networking_mini_menu" class="locked nav-item">
							<a name="Networking" class="nav-link i18n" href="#" data-toggle="collapse" data-target="#networking_mini_submenu" aria-expanded="false">Network Settings &blacktriangledown;</a>
							<ul class="collapse in" id="networking_mini_submenu" role="menu" aria-labelledby="networking_mini_menu">
								<li id="networking_status_mini_menu" class="nav-link" onclick="clickStatusPage()"><a class="i18n" name="Networking Status" href="#">Status</a></li>
								<li id="networking_connections_mini_menu" class="locked d-none nav-link" onclick="clickConnectionsPage()"><a class="i18n" name="View Connections" href="#">Manage Connections</a></li>
								<li id="networking_edit_mini_menu" class="locked d-none nav-link" onclick="clickEditConnectionPage()"><a class="i18n" name="Edit Connection" href="#">Edit Connection</a></li>
								<li id="networking_scan_mini_menu" class="locked d-none nav-link" onclick="clickScanPage()"><a class="i18n" name="Wifi Scan" href="#">Wifi Scan</a></li>
								<li id="networking_version_mini_menu" class="nav-link" onclick="clickVersionPage()"><a class="i18n" name="Version" href="#">System Version</a></li>
							</ul>
						</li>
						<li id="logging_mini_menu" class="locked d-none nav-link" onclick="clickLoggingPage()"><a class="i18n" name="Logging" href="#">Logging</a></li>
						<li id="swupdate_mini_menu" class="locked d-none nav-link" onclick="clickSWUpdatePage()"><a class="i18n" name="Firmware Update" href="#">Firmware Update</a></li>
						<li id="usermanage_mini_menu" class="locked d-none nav-item">
							<a href="#" class="nav-link i18n" name="Manage Users" data-toggle="collapse" data-target="#usermanage_mini_submenu" aria-expanded="false">Manage Users &blacktriangledown;</a>
							<ul class="collapse in" id="usermanage_mini_submenu" role="menu" aria-labelledby="usermanage_mini_menu">
								<li id="add_del_user_mini_menu" class="locked d-none nav-link" onclick="clickAddOrDelUser()"><a class="i18n" name="Add Del User" href="#">Add/Del User</a></li>
								<li id="update_password_mini_menu" class="locked d-none nav-link" onclick="clickUpdatePassword('Update login user password.')"><a class="i18n" name="Update Password" href="#">Update Password</a></li>
							</ul>
						</li>
						<li id="advanced_mini_menu" class="locked d-none nav-link " onclick="clickAdvancedPage()"><a class="i18n" name="Advanced" href="#">Advanced Settings</a></li>
						<li id="datetime_mini_menu" class="locked d-none nav-link " onclick="clickDatetimePage()"><a class="i18n" name="Datetime" href="#">Datetime Settings</a></li>
					</ul>
				</ul>
			</div>
		</nav>

		<div class="container-fluid">
			<div class="row mt-3">
				<nav class="col-md-2 d-none d-md-block bg-light">
					<ul class="navbar-nav" id="main_menu">
						<li id="networking_main_menu" class="locked nav-item">
							<a name="Networking" class="nav-link i18n" href="#" data-toggle="collapse" data-target="#networking_main_submenu" aria-expanded="false">Network Settings &blacktriangledown;</a>
							<ul class="collapse show" id="networking_main_submenu" role="menu" aria-labelledby="networking_main_menu">
								<li id="networking_status_main_menu" class="nav-link" onclick="clickStatusPage()"><a class="i18n" name="Networking Status" href="#">Status</a></li>
								<li id="networking_connections_main_menu" class="locked d-none nav-link" onclick="clickConnectionsPage()"><a class="i18n" name="View Connections" href="#">Manage Connections</a></li>
								<li id="networking_edit_main_menu" class="locked d-none nav-link" onclick="clickEditConnectionPage()"><a class="i18n" name="Edit Connection" href="#">Edit Connection</a></li>
								<li id="networking_scan_main_menu" class="locked d-none nav-link" onclick="clickScanPage()"><a class="i18n" name="Wifi Scan" href="#">Wifi Scan</a></li>
								<li id="networking_version_main_menu" class="nav-link" onclick="clickVersionPage()"><a class="i18n" name="Version" href="#">System Version</a></li>
							</ul>
						</li>
						<li id="logging_main_menu" class="locked d-none nav-link" onclick="clickLoggingPage()"><a class="i18n" name="Logging" href="#">Logging</a></li>
						<li id="swupdate_main_menu" class="locked d-none nav-link" onclick="clickSWUpdatePage()"><a class="i18n" name="Firmware Update" href="#">Firmware Update</a></li>
						<li id="usermanage_main_menu" class="locked d-none nav-item">
							<a href="#" class="nav-link i18n" name="Manage Users" data-toggle="collapse" data-target="#usermanage_main_submenu" aria-expanded="false">Manage Users ▼</a>
							<ul class="collapse in" id="usermanage_main_submenu" role="menu" aria-labelledby="usermanage_main_menu">
								<li id="add_del_user_main_menu" class="locked d-none nav-link" onclick="clickAddOrDelUser()"><a class="i18n" name="Add Del User" href="#">Add/Del User</a></li>
								<li id="update_password_main_menu" class="locked d-none nav-link" onclick="clickUpdatePassword('Update login user password.')"><a class="i18n" name="Update Password" href="#">Update Password</a></li>
							</ul>
						</li>
						<li id="advanced_main_menu" class="locked d-none nav-link " onclick="clickAdvancedPage()"><a class="i18n" name="Advanced" href="#">Advanced Settings</a></li>
						<li id="datetime_main_menu" class="locked d-none nav-link " onclick="clickDatetimePage()"><a class="i18n" name="Datetime" href="#">Datetime Settings</a></li>
					</ul>
				</nav>
				<main role="main" class="col-md-8 ml-sm-auto">
					<p id="main_section"></p>
				</main>
				<div id="help_section" class="col-md-2 d-none d-md-block mt-3 text-center">
					<div id="alert-msg-main"></div>
					<img src="assets/img/logo.png" class="img-fluid" alt="Responsive image">
					<h4 class="i18n" name="Need help">Need help?</h4>
				</div>
			</div>
		</div>
	</body>
</html>
