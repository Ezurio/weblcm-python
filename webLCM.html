<!DOCTYPE html>
<!--
  Copyright (c) 2017-2020, Laird
  Permission to use, copy, modify, and/or distribute this software for any
  purpose with or without fee is hereby granted, provided that the above
  copyright notice and this permission notice appear in all copies.
  THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
  REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
  AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
  INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
  LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
  OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
  PERFORMANCE OF THIS SOFTWARE.

  Contact: support@lairdconnect.com
-->
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
		<meta name="description" content="">
		<meta name="author" content="">

		<title>WebLCM</title>

		<!-- Bootstrap core CSS -->
		<link href="assets/css/bootstrap.min.css" rel="stylesheet">

		<!-- Custom styles for this template -->
		<link href="assets/css/jquery.dataTables.min.css" rel="stylesheet">
		<link href="assets/css/dataTables.bootstrap.min.css" rel="stylesheet">
		<link href="assets/css/buttons.bootstrap.min.css" rel="stylesheet">
		<link href="assets/css/dashboard.css" rel="stylesheet">

		<script src="assets/js/jquery.min.js"></script>
		<script src="assets/js/bootstrap.min.js"></script>
		<script src="assets/js/jquery.dataTables.min.js"></script>
		<script src="assets/js/dataTables.bootstrap.min.js"></script>
		<script src="assets/js/dataTables.buttons.min.js"></script>
		<script src="assets/js/buttons.bootstrap.min.js"></script>
		<script src="assets/js/buttons.html5.min.js"></script>
		<script src="assets/js/jquery-ui.min.js"></script>
		<script src="assets/js/jquery.ui.touch-punch.min.js"></script>
		<script src="assets/js/jquery.i18n.properties.min.js"></script>

		<script>

		var defines;
		var i18nData;
		var currUserPermission;
		var currUser;

		function consoleLog(message){
			console.log(message);
		}

		function loadjscssfile(key, filetype){
			var jsPath = "plugins/" + key + "/" + key + "." + filetype;
			if (filetype=="js"){
				var fileref=document.createElement('script');
				fileref.setAttribute("type","text/javascript");
				fileref.setAttribute("src", jsPath);
			}
			if (typeof fileref!="undefined"){
				document.getElementsByTagName("head")[0].appendChild(fileref);
				fileref.onload = function(){
					window[key + "AUTORUN"](0);
				}
			}
		}

		function addPlugin(key){
			var main_item = $("#"+key+"_frame").contents().find("#"+key+"_main_menu")[0];
			var mini_item = $("#"+key+"_frame").contents().find("#"+key+"_mini_menu")[0];
			$("#main_menu").append(main_item);
			$("#mini_menu").append(mini_item);
		}

		//TBD: HTMLs should be loaded per user
		function weblcm_init(){
			let i, lang;
			let plugins = ["networking", "logging", "swupdate", "usermanage", "advanced"];

			for (i = 0; i < plugins.length; i++){
				loadjscssfile(plugins[i], "js");
				addPlugin(plugins[i]);
			}

			lang = window.navigator.userLanguage || window.navigator.language;
			if(lang == "zh" || lang == "zh-CN"){
				$("#language").val("zh-CN");
			}
			else {
				$("#language").val("en");
			}
			$("#language").change()
		}

		function clearReturnData(){
			$("[id^='return']").removeClass();
			$("[id^='return']").html("");
		}

		function notificationPermission(){
			Notification.requestPermission();
		}

		function checkNotifyPermission(){
			if (typeof Notification === 'undefined' || !Notification){
				$("#enableNotify").addClass("disabled");
				$("#enableNotify").html("Not Supported");
				return;
			}
			if (Notification.permission === "granted"){
				$("#enableNotify").html("Enabled");
				$("#enableNotify").addClass("disabled");
				$("#disableNotify").removeClass("hidden");
			}
		}

		function sendNotification(title, message){
			if (typeof Notification === 'undefined' || !Notification){
				return false;
			}
			if (Notification.permission === "granted"){
				var mobile = document.getElementById("mobileMenu");
				if (mobile.offsetParent === null){
					var notification = new Notification(title, {
						icon: 'assets/img/logo.png',
						body: message,
					});
					return true;
				}
			}
			return false;
		}

		function dismissibleAlerts(){
			var returnData = document.getElementById("returnDataHelp");
			var dismissButton = document.createElement("button");
			var dismissSpan = document.createElement("span");
			var spanX = document.createTextNode("X");
			dismissButton.className = "close";
			dismissButton.appendChild(dismissSpan);
			dismissButton.onclick = function() {
				clearReturnData();
			};
			dismissSpan.appendChild(spanX);
			returnData.appendChild(dismissButton);
		}

		function CustomMsg(message, err){
			nMsg = err ? "Failure":"Success";
			if (!sendNotification(nMsg, i18nData[message] ? i18nData[message] : message)){
				if (message.length >= 20){
					$("#returnDataNav").css( "fontSize", "12px" );
				}
				$("[id^='return']").removeClass();
				if(err)
					$("[id^='return']").addClass("alert alert-dismissible alert-danger");
				else
					$("[id^='return']").addClass("alert alert-dismissible alert-success");
				$("[id^='return']").html(i18nData[message]);
				dismissibleAlerts();
			}
		}

		function SDCERRtoString(SDCERR){
			$("[id^='return']").removeClass();
			switch(parseInt(SDCERR)) {
				case defines.SDCERR.SDCERR_SUCCESS:
					if (!sendNotification("Success", "")){
						$("[id^='return']").addClass("alert alert-dismissible alert-success");
						$("[id^='return']").html(i18nData['Success']);
					}
					break;
				case defines.SDCERR.SDCERR_FAIL:
					if (!sendNotification("Failure", "")){
						$("[id^='return']").addClass("alert alert-dismissible alert-danger");
						$("[id^='return']").html(i18nData['Failure']);
					}
					break;
				default:
					if (!sendNotification("Unknown Data", "")){
						$("[id^='return']").addClass("alert alert-dismissible alert-danger");
						$("[id^='return']").html(i18nData['Unknown Data']);
					}
			}
			dismissibleAlerts();
		}

		function enterKeyPress(e){
			if(e.keyCode === 13){ //enter key
				e.preventDefault();
				login();
			}
		}

		function login(user, passwd){
			var creds = {
				username: $("#username").val(),
				password: $("#password").val(),
			}

			if (user != undefined) {
				creds.username = user;
			}

			if (passwd != undefined) {
				creds.password = passwd;
			}
			// Clear any old return code message
			clearReturnData()

			$.ajax({
				url: "login",
				data: JSON.stringify(creds),
				type: "POST",
				contentType: "application/json",
			})
			.done(function( data ) {
				if (data.SDCERR == defines.SDCERR.SDCERR_SUCCESS){
					$("#loggin").addClass("hidden");
					$("#loggout").removeClass("hidden");

					clearReturnData();

					currUser = creds.username;
					currUserPermission = data.PERMISSION;

					if (data.REDIRECT == 1){
						$("#networking_main_menu").addClass("hidden");
						$("#networking_mini_menu").addClass("hidden");
						clickUpdatePassword();
					}
					else{
						const MENU_ID_TYPE_OFFSET = 10; //"_main_menu"
						$(".locked").each(function() {
							let id = $(this).attr('id');
							if (-1 !== currUserPermission.indexOf(id.slice(0, id.length - MENU_ID_TYPE_OFFSET))){
								$(this).removeClass("hidden");
							}
						});
						$("#networking_main_menu").removeClass("hidden");
						$("#networking_mini_menu").removeClass("hidden");
						$("#usermanage_main_menu").removeClass("hidden");
						$("#usermanage_mini_menu").removeClass("hidden");
						clickStatusPage();
					}
				} else {
					CustomMsg("Credentials are invalid", true);
				}
				document.getElementById("username").value = null;
				document.getElementById("password").value = null;
			})
			.fail(function(data) {
				consoleLog("Error, couldn't get login.. retrying");
			});
		}

		function logout(){
			$.ajax({
				url: "logout",
				data: {},
				type: "GET",
				contentType: "application/json",
			})
			.done(function( data ) {
				if (data.SDCERR == defines.SDCERR.SDCERR_SUCCESS){
					$("#loggout").addClass("hidden");
					$("#loggin").removeClass("hidden");
					$(".locked").addClass("hidden");
					clickStatusPage();
				}
				document.getElementById("username").value = null;
				document.getElementById("password").value = null;

				location.reload();
			})
			.fail(function() {
				consoleLog("Error, couldn't get logout.. retrying");
			});
		}

		function expiredSession(){
			$("#loggout").addClass("hidden");
			$("#loggin").removeClass("hidden");
			$(".locked").addClass("hidden");
			clickStatusPage();
		}

		$(document).ready(function() {
			$.ajax({
				url: "definitions",
				type: "GET",
				contentType: "application/json",
			})
			.done(function( data ) {
				defines = data;
				weblcm_init();
			});
		});

		function setLanguage (id) {
			$("#" + id + " .i18n").each(function () {
				value = $(this).attr('name')
				if(this.tagName.toLowerCase() === 'input') {
					if( $(this).attr("placeholder")) {
						$(this).attr("placeholder", i18nData[value]);
					}
					if($(this).attr("value")){
						$(this).attr("value",i18nData[value]);
					}
				} else if (this.tagName.toLowerCase() === 'option'){
					if($(this).text()){
						$(this).text(i18nData[value]);
					}
				} else {
					$(this).html(i18nData[value]);
				}
			});
		}

		function onChangeLanguageType(){
			lang = $("#language").val()
			$.ajax({
				url:'assets/i18n/'+lang+'.json',
				dataType:'json',
				success:function (data) {
					i18nData = data
					setLanguage("main_menu");
					setLanguage("navbar");
					setLanguage("main_section");
					setLanguage("helpSection");
				}
			});
		}

		</script>

	</head>

	<body>

		<iframe id="networking_frame" src="plugins/networking/networking.html" style="display: none;"></iframe>
		<iframe id="logging_frame" src="plugins/logging/logging.html" style="display: none;"></iframe>
		<iframe id="swupdate_frame" src="plugins/swupdate/swupdate.html" style="display: none;"></iframe>
		<iframe id="usermanage_frame" src="plugins/usermanage/usermanage.html" style="display: none;"></iframe>
		<iframe id="advanced_frame" src="plugins/advanced/advanced.html" style="display: none;"></iframe>

		<nav class="navbar navbar-inverse navbar-fixed-top">
			<div class="container-fluid">
				<div class="navbar-header">
					<button id="mobileMenu" type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
						<span class="sr-only">Toggle navigation</span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					<a class="navbar-brand hidden-xs hidden-sm" href="#">WebLCM</a>
					<img class="navbar-brand img-responsive visible-xs-block visible-sm-block" alt="Brand" src="assets/img/logo_white.png" width="90" height="34" style="padding-left:2px;padding-right:0px;">
					<span class="navbar-brand visible-xs-block visible-sm-block" style="padding-top:13px;padding-left:8px;padding-right:8px;">
						<span id="returnDataNav" class="" style="padding-left:8px;padding-right:8px;" role="alert"></span>
					</span>
				</div>
				<div id="navbar" class="navbar-collapse collapse">
					<form id="loggin" class="navbar-form navbar-right">
						<div class="form-group">
							<input type="text" id="username" name="Username" placeholder="Username" class="form-control i18n">
						</div>
						<div class="form-group">
							<input type="password" id="password" name="Password" placeholder="Password" class="form-control i18n" onkeypress="enterKeyPress(event)">
						</div>
						<div class="form-group">
							<input type="button" onclick="login()" class="btn btn-default i18n" href="#" name="Sign in" value="Sign in">
						</div>
						<div class="form-group">
							<select class="form-control" id="language" onchange="onChangeLanguageType()">
								<option value="en" default>English</option>
								<option value="zh-CN">中文简体</option>
							</select>
						</div>
					</form>
					<form id="loggout" class="navbar-form navbar-right hidden">
						<div class="form-group">
							<a type="button" onclick="logout()" class="btn btn-default i18n" name= "Log out" href="#">Log out</a>
						</div>
					</form>
					<ul class="nav navbar-nav navbar-right visible-xs" id="mini_menu">
					</ul>
				</div>
			</div>
		</nav>

		<div class="container-fluid">
			<div class="row">
				<div class="hidden-xs col-sm-3 col-md-2 sidebar">
					<ul class="nav nav-sidebar" id="main_menu">
					</ul>
				</div>
				<div class="col-xs-12 col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
					<div class="row placeholders">
						<div class="col-xs-12 col-sm-12 col-md-9 col-lg-9 placeholder">
							<p id="main_section"></p>
						</div>
						<div id="helpSection" class="hidden-xs hidden-sm col-md-3 col-lg-3 placeholder">
							<div id="returnDataHelp" class="" role="alert"></div>
							<img src="assets/img/logo.png" width="320" height="87" class="img-responsive" alt="Responsive image" style="border-radius: 0%" ondragstart="return false;">
							<h4 class="i18n" name="Need help">Need help?</h4>

							<br>
							<span id="infoText" class="text-muted"></span>
						</div>
					</div>
				</div>
			</div>
		</div>
	</body>
</html>
