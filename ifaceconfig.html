<!--
Web Based Configuration Tool for WB Products
Joe Conley, joe.conley@lairdtech.com
-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Web based configuration tool for WB platform">
    <meta name="author" content="Joseph Conley:joe.conley@lairdtech.com">
    <link rel="icon" href="/assets/img/laird_logo.png">

    <!-- Le styles -->
    <link href="../assets/css/bootstrap.min.css" rel="stylesheet">
    <script src="../assets/js/jquery.min.js"></script>
  </head>

  <body>

    <div class="container">
	<br>
		<div class="row">
		<?php
		if (file_exists("/var/www/docs/assets/img/DakLogo.png"))
		{
		?>
		<img class="brand-logo" src="/assets/img/DakLogo.png"></img>
		<?php
		}
		else
		{
		?>
		<img class="brand-logo" src="/assets/img/laird_logo.png" width="320" height="87"></img>
		<?php
		}
		?>
		</div>
	<br>
	<nav class="navbar navbar-default" role="navigation">
		<ul class="nav nav-tabs nav-justified">
			<li><a href="/status.html">Status</a></li>
			<li><a href="/profileconfig.html">Wi-Fi</a></li>
			<li><a href="/globalconfig.html">Wi-Fi Options</a></li>
			<li class="active"><a href="/ifaceconfig.html">Interfaces</a></li>
			<li><a href="/advancedconfig.html">Advanced</a></li>
			<li><a href="/about.html">About</a></li>
		</ul>
	
	<?php
		exec('sdc_cli status', $sdcstatus);
		$TitleStatus=ucwords(substr($sdcstatus[0],11));
		if (strlen($TitleStatus) == 9)
		{
			echo "<title>LCU - $TitleStatus</title>";
		}
		else
		{
			echo "<title>LCU - Enabled</title>";
		}
	?>
	<!-- Show profile -->
	<div class="panel panel-default">
	<div class="row panel-body">
	<div class="col-sm-8 col-sm-offset-2 col-md-4 col-md-offset-2">
	<form class="btn-toolbar" action = "" method = "post">
		<br>
		<h2>Interface Configuration</h2>
		<?php
		exec("sdc_cli iface show", $ifaceShow);
		$listLen=count($ifaceShow);
		//var_dump($ifaceShow);
		$ifacelist=$_POST["ifacelist"];
		?>
		<select name='ifacelist' size='4' class='form-control' style='width:198px'>
		<?php
		for ($i = 0; $i <= $listLen; $i++)
		{
			if (substr($ifaceShow[$i],0,5) == "iface")
			{
				$ifaceItem=explode(" ",$ifaceShow[$i]);
				if ($ifacelist == $ifaceItem[1])
				{
					echo "<option selected>" . "$ifaceItem[1]" . "</option>";
				}
				else
				{
					if ($ifaceItem[1] != "lo")
					{
						echo "<option>" . "$ifaceItem[1]" . "</option>";
					}
				}
			}
		}
		?>
		</select>
		<br>
		<button class="btn btn-primary" type="submit" id="formEdit" name="formEdit">Edit</button>
	</form>
	</div> <!-- col-sm-8 col-sm-offset-2 col-md-4 col-md-offset-2 -->
	<div class="col-sm-8 col-sm-offset-2 col-md-4 col-md-offset-1">
	<?php
	if (isset($_POST['formEdit']))
		{
			echo "<form name='Editiface' action='' method='post'>";
			$ifacelist=$_POST["ifacelist"];
			echo "<br>";
			//var_dump($ifacelist);
			//var_dump($ifaceShow);
			for ($i = 0; $i <= $listLen; $i++)
			{
				if (substr($ifaceShow[$i],0,4) == "auto")
				{
					if (trim($ifaceShow[$i]) == "auto " . $ifacelist)
					{
						$getAutoState=1;
					}
				}
				if (substr($ifaceShow[$i],6,strlen($ifacelist)) == "$ifacelist")
				{
					echo "<h2>Edit Interface $ifacelist</h2>";
					if (isset($_POST['EditIfaceSub']))
					{
						?>
						<div class="alert alert-success" id="hideSuccess">
							<h4>Success!</h4>
						</div>
						<script>
							setTimeout(function() {
							$('#hideSuccess').hide();
							}, 1000);
						</script>
						<?php
					}
					echo "<br>";
					$ifaceDHCPstatus=explode(" ",$ifaceShow[$i]);
					$ifaceDHCPstatus=$ifaceDHCPstatus[3];
					echo "Address Aquisition:<br><select class='form-control input-sm' name='DHCPstatus'>";
					if ($ifaceDHCPstatus == "dhcp")
					{
						echo "<option value='on' selected>dhcp</option>";
						echo "<option value='off' >static</option>";
					}
					else
					{
						echo "<option value='on'>dhcp</option>";
						echo "<option value='off' selected>static</option>";
					}
					?>
					</select>
					<br>
					<?php
					for ($j = 0; $j <= 5; $j++)
					{
						if ($ifacelist == "br0" && substr(trim($ifaceShow[$i + $j]),0,12) == "bridge_ports")
						{
							$bridge_port_choice=explode(" ", substr(trim($ifaceShow[$i + $j]),13));
							$GetBridgeOne=$bridge_port_choice[0];
							$GetBridgeTwo=$bridge_port_choice[1];
							if ($GetBridgeOne == "wlan0")
							{
								$GetBridgeOne="wl";
							}
							if ($GetBridgeTwo == "wlan0")
							{
								$GetBridgeTwo="wl";
							}
							?>
							<div class="row">
							<div class="col-xs-6">
							<?php
							echo "Bridge:<br><select class='form-control input-sm' name='BridgeOne'>";
							for ($k = 0; $k <= $listLen; $k++)
							{
								if (substr($ifaceShow[$k],0,5) == "iface")
								{
									$ifaceItem=explode(" ",$ifaceShow[$k]);
										if ($GetBridgeOne == $ifaceItem[1])
										{
											echo "<option selected>" . "$ifaceItem[1]" . "</option>";
										}
										else
										{
											echo "<option>" . "$ifaceItem[1]" . "</option>";
										}
								}
							}
							?>
							</select>
							</div>
							<div class="col-xs-6">
							<?php
							echo "With:<br><select class='form-control input-sm' name='BridgeTwo'>";
							for ($l = 0; $l <= $listLen; $l++)
							{
								if (substr($ifaceShow[$l],0,5) == "iface")
								{
									$ifaceItem=explode(" ",$ifaceShow[$l]);
										if ($GetBridgeTwo == $ifaceItem[1])
										{
											echo "<option selected>" . "$ifaceItem[1]" . "</option>";
										}
										else
										{
											echo "<option>" . "$ifaceItem[1]" . "</option>";
										}
								}
							}
							?>
							</select>
							</div>
							</div>
							<br>
							<?php
						}
						
						if (substr(trim($ifaceShow[$i + $j]),0,7) == "address")
						{
							$getIPAddress=substr(trim($ifaceShow[$i + $j]),8);	
						}
						if (substr(trim($ifaceShow[$i + $j]),0,9) == "broadcast")
						{
							$getIPBroadcast=substr(trim($ifaceShow[$i + $j]),10);	
						}
						if (substr(trim($ifaceShow[$i + $j]),0,7) == "netmask")
						{
							$getIPNetmask=substr(trim($ifaceShow[$i + $j]),8);	
						}
					}
					echo "Address:<br><input class='form-control input-sm' type='text' name='IPAddress' value='$getIPAddress'>";
					echo "<br>";
					echo "Broadcast:<br><input disabled class='form-control input-sm' type='text' name='IPBroadcast' value='$getIPBroadcast'>";
					echo "<br>";
					echo "Netmask:<br><input class='form-control input-sm' type='text' name='IPNetmask' value='$getIPNetmask'>";
					echo "<br>";
				}
			}
			if ($getAutoState == 1)
			{
				echo "<input type='checkbox' name='AutoState' value='on' checked> Start interface $ifacelist on boot";
				echo "<br>";
			}
			if ($getAutoState != 1)
			{
				echo "<input type='checkbox' name='AutoState' value='on'> Start interface $ifacelist on boot";
				echo "<br>";			
			}
			?>
			<input class='form-control input-sm' type = "hidden" name = "ifacelist" value = "<?php echo $_POST['ifacelist']; ?>"/>
			<input class='form-control input-sm' type = "hidden" name = "ifaceEdited" value = "<?php echo $_POST['ifaceEdited']; ?>"/>
			<br>
			<button class="btn btn-primary" type='submit' name='EditIfaceSub'>Submit</button>
			</form>
			<?php
		}
	if (isset($_POST['ifaceEdited']))
		{
			$Editiface=$_POST['Editiface'];
			$ifacelist=$_POST['ifacelist'];
			$ifaceEdited=$_POST['ifaceEdited'];
			$IPAddress=$_POST['IPAddress'];
			$IPBroadcast=$_POST['IPBroadcast'];
			$IPNetmask=$_POST['IPNetmask'];
			$BridgeOne=$_POST['BridgeOne'];
			$BridgeTwo=$_POST['BridgeTwo'];
			$DHCPstatus=$_POST['DHCPstatus'];
			$AutoState=$_POST['AutoState'];
			
			//Set DHCP status
			exec("sdc_cli iface set dhcp $ifacelist $DHCPstatus");

			//Update IP address
			if (strlen($IPAddress) != 0)
			{
				exec("sdc_cli iface set address $ifacelist $IPAddress");
			}
			if (strlen($IPNetmask) != 0)
			{
				exec("sdc_cli iface set netmask $ifacelist $IPNetmask");
			}
			//Update bridge config
			if ( $BridgeOne != $GetBridgeOne || $BridgeTwo != $GetBridgeTwo)
			{
				exec("sdc_cli iface set bridge_ports br0 $BridgeOne $BridgeTwo");
			}
			//Set interface auto/noauto
			if ($AutoState != "on")
			{
				exec("sdc_cli iface set auto $ifacelist off");
			}
			else
			{
				exec("sdc_cli iface set auto $ifacelist on");
			}
		
			echo "<form id=refresh action='' method = 'post'>";
			echo "<input type = 'hidden' name = 'formEdit' value = '$ifaceEdited' />";
			echo "<input type = 'hidden' name = 'ifacelist' value = '$ifacelist' />";
			echo "<input type = 'hidden' name = 'EditIfaceSub' value = '$EditIfaceSub' />";
			echo "</form>";
			echo "<script>document.getElementById('refresh').submit();</script>";
		}
	?>
	</div> <!-- col-sm-8 col-sm-offset-2 col-md-4 col-md-offset-1 -->
	</div> <!-- panel panel-default -->
	</div> <!-- row panel-body -->
	</nav> <!-- navbar navbar-default -->
	<!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
	<script src="../assets/js/bootstrap.min.js"></script>

	</div> <!-- /container -->
  </body>
</html>
