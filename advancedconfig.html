<!--
Web Based Configuration Tool for WB Products
Joe Conley, joe.conley@lairdtech.com
-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Web based configuration tool for WB platform">
    <meta name="author" content="Joseph Conley:joe.conley@lairdtech.com">
    <link rel="icon" href="/assets/img/laird_logo.png">

    <!-- Le styles -->
    <link href="../assets/css/bootstrap.min.css" rel="stylesheet">

<title>SCU - Advanced Configuration</title>
  </head>

  <body>
   <div class="container">
	<br>
		<div class="row">
		<?php
		if (file_exists("/var/www/docs/assets/img/DakLogo.png"))
		{
		?>
		<img class="brand-logo" src="/assets/img/DakLogo.png"></img>
		<?php
		}
		else
		{
		?>
		<img class="brand-logo" src="/assets/img/laird_logo.png" width="320" height="87"></img>
		<?php
		}
		?>
		</div>
	<br>
	<nav class="navbar navbar-default " role="navigation">
		<ul class="nav nav-tabs nav-justified">
			<li><a href="/status.html">Status</a></li>
			<li><a href="/profileconfig.html">Profile Configuration</a></li>
			<li><a href="/globalconfig.html">Global Configuration</a></li>
			<li class="active"><a href="/advancedconfig.html">Advanced</a></li>
			<li><a href="/about.html">About</a></li>
		</ul>
	<div class="panel panel-default">
	<div class="row panel-body">
	<br>
	<div class="col-xs-12 col-sm-10 col-md-10 col-sm-offset-2 col-md-offset-2"><h2>Advanced Configuration</h2></div>

	<br>
		<form name="PasswordChange" class="form-horizontal col-sm-8 col-sm-offset-2 col-md-offset-2" role="form" action='' method='post'>
		  <div class="form-group">
			<label for="inputCurrentPass" class="col-md-4 control-label">Current Admin Password:</label>
			<div class="col-md-6">
			<?php 
			  echo "<input type='password' name='CurrentPass' class='form-control input-sm' id='inputCurrentPass' value='$getCurrentPass'>";
			?>
			</div>
		  </div>
		  <div class="form-group">
			<label for="inputPassword1" class="col-md-4 control-label">New Admin Password:</label>
			<div class="col-md-6">
			<?php
			  echo "<input type='password' name='NewPass' class='form-control input-sm' id='inputPassword1' value='$getNewPass'>";
			?>
			</div>
		  </div>
		  <div class="form-group">
			<label for="inputPassword2" class="col-md-4 control-label">Confirm Admin Password:</label>
			<div class="col-md-6">
			<?php
			  echo "<input type='password' name='NewPass2' class='form-control input-sm' id='inputPassword2' value='$getNewPass2'>";
			?>
			</div>
		  </div>
		  <div class="form-group">
			<div class="col-md-offset-4 col-md-8">
			  <button type="submit" class="btn btn-primary">Submit Password Change</button>
			  <input type = "hidden" name = "PasswordChange" value = "<?php echo $_POST['PasswordChange']; ?>"/>
			</div>
		  </div>
		</form>
		<br>
		<br>
		<form name="UploadCert" class="form-horizontal col-sm-8 col-sm-offset-2 col-md-offset-2" role="form" action="" method="post" enctype="multipart/form-data">
			<label for="myFile" class="col-md-4 control-label">Upload Certificate</label>
			<input type="file" class="col-md-6" name="myFile">
			<br>
			<br>
			<div class="form-group">
				<div class="col-md-offset-4 col-md-8">
					<button type="submit" class="btn btn-primary">Upload</button>
					<input type = "hidden" name="UploadCert" value="<?php echo $_POST['UploadCert']; ?>"/>
				</div>
			</div>
		</form>		
		<br>
		<br>		
		
		<form name="RemoteUpdate" class="form-horizontal col-sm-8 col-sm-offset-2 col-md-offset-2" role="form" action='' method='post'>
		  <div class="form-group">
			<label for="RemotePath1" class="col-md-4 control-label">Remote Update Path</label>
			<div class="col-md-6">
				<?php
				  echo "<input type='text' name='RemotePath' class='form-control input-sm' id='RemotePath1' placeholder='//<server/path/to/images>/fw.txt' value='$getRemotePath'>";
				?>	
			</div>
				<div class="col-md-offset-4 col-md-3 ">
					  <label class="radio radio-inline">
						<?php
						  echo "<input type='radio' name='optionsRadios' id='optionsRadios1' value='http:' checked>";
						?>	
						HTTP
					  </label>
					  <label class="radio radio-inline">
						<?php
						  echo "<input type='radio' name='optionsRadios' id='optionsRadios2' value='ftp:'>";
						?>	
						FTP
					  </label>
				</div>
			  </div>
		  <div class="form-group">
			<div class="col-md-offset-4 col-md-8">
			  <button type="submit" class="btn btn-primary">Start Remote Update</button>
			  <input type = "hidden" name = "RemoteUpdate" value = "<?php echo $_POST['RemoteUpdate']; ?>"/>
			</div>
		  </div>
		</form>
		<br>
		<?php
		$FWupdateLog='fw_update_log.txt';
		$FWupdateLogString=implode(file("fw_update_log.txt"));
		$FWupdateLogPos=strpos($FWupdateLogString, 'Done.');
		if (file_exists($FWupdateLog) && !isset($_POST['RemoteReboot']) && !isset($_POST['RemoteUpdate']))
		{
		?>
        <div class="col-xs-12 col-sm-8 col-md-8 col-sm-offset-2 col-md-offset-2">
			<div class="panel-group" id="accordion">
			  <div class="panel panel-default">
				<div class="panel-heading">
				  <h4 class="panel-title">
					<a data-toggle="collapse" data-parent="#accordion" href="#collapseOne">
					Remote Update Log:
					</a>
				  </h4>
				</div>
				<div id="collapseOne" class="panel-collapse collapse">
					<div class="panel-body">
						<textarea class="form-control" rows="10"><?php
							echo implode(file("fw_update_log.txt"));
							?>
						</textarea>
						<?php
						if ($FWupdateLogPos === false)
						{
						
						}
						else
						{
						?>
						<br>
						<form name="RemoteReboot" role="form" action='' method='post'>
						<button type='submit' class='btn btn-warning btn-block'>Reboot device to complete remote update.</button>
						<input type = "hidden" name = "RemoteReboot" value = "<?php echo $_POST['RemoteReboot']; ?>"/>
						</form>
						<?php
						}
						?>
					</div>     
				</div>
			  </div>
			</div>
		</div>
		<?php
		}
		?>
		<br>
		<?php
	if (isset($_POST['PasswordChange']))
		{
			$PasswordChange=$_POST["PasswordChange"];
			$CurrentPass=$_POST["CurrentPass"];
			$NewPass=$_POST["NewPass"];
			$NewPass2=$_POST["NewPass2"];
			
			$RealPasswordFile='/etc/lighttpd/lighttpd.password';
			$RealCurrentUser=exec("awk -F ':' '{ print $1 }' /etc/lighttpd/lighttpd.password");
			$RealCurrentPass=exec("awk -F ':' '{ print $2 }' /etc/lighttpd/lighttpd.password");
			if ($RealCurrentPass == $CurrentPass)
			{
				if ($NewPass == $NewPass2)
				{
					if (strlen($NewPass) > 0 && strlen($NewPass2) > 0)
					{
						if (file_exists($RealPasswordFile))
						{	
							$fp = fopen($RealPasswordFile, 'w');
							fwrite($fp, $RealCurrentUser . ":" . $NewPass2 . "\n");
							fclose($fp);						
						}
						else 
						{
							exec('touch /etc/lighttpd/lighttpd.password');
							$fp = fopen($RealPasswordFile, 'w');
							fwrite($fp, $RealCurrentUser . ":" . $NewPass2 . "\n");
							fclose($fp);	
						}	
					}
					else
					{
						?>
						<script>
						alert("New Passwords must not be blank!");
						</script>
						<?php					
					}
				}
				else
				{
					?>
					<script>
					alert("New passwords do not match!");
					</script>
					<?php
				}
			}
			elseif (strlen($CurrentPass) > 0)
			{
				?>
				<script>
				alert("Current password is incorrect");
				</script>
				<?php
			}
			
			echo "<form id=refresh action='' method = 'post'>";
			echo "</form>";
			// echo "<script>document.getElementById('refresh').submit();</script>";
		}
	if (isset($_POST['RemoteUpdate']))
		{
			$RemoteUpdate=$_POST["RemoteUpdate"];
			$RemotePath=$_POST["RemotePath"];
			$optionsRadios=$_POST["optionsRadios"];
			
			if (strlen($RemotePath) > 0)
			{
				?>
				<br>
				<br>
				<div class="alert alert-danger col-md-offset-2 col-md-8">
					<strong>Remote Update Started:</strong>
					Please check log for results. This page will refresh in 5 seconds and the log will be viewable. 
					<br>
					<?php
					exec('fw_update -x --url ' . $optionsRadios . $RemotePath . ' &> fw_update_log.txt &');
					echo "<form id=refresh action='' method = 'post'>";
					echo "</form>";
					?>
				<meta http-equiv="refresh" content="5" >
				</div>
				<?php
			}
			
			echo "<form id=refresh action='' method = 'post'>";
			echo "</form>";
		}
	if (isset($_POST['RemoteReboot']))
		{
			?>
			<div class="alert alert-danger col-md-offset-2 col-md-8">
				<strong>Device Rebooting!</strong>
				The page will attempt to redirect in 20 seconds if IP address remains the same. 
			</div>
			<?php		
			exec('sleep 3 ; reboot &');
			?>
			<meta http-equiv="refresh" content="20;url=/about.html" />
			<?php
		}
	if (isset($_POST['UploadCert']))
		{
			$UploadCert=$_POST["UploadCert"];
						
			define("UPLOAD_DIR", "/etc/ssl/");
 
			if (!empty($_FILES["myFile"]))
			{
				$myFile = $_FILES["myFile"];
			 
				if ($myFile["error"] !== UPLOAD_ERR_OK) 
				{
					?>
					<div class="alert alert-danger col-md-offset-2 col-md-8">
						<strong>Error Occurred Uploading Cert</strong>
					</div>
					<?php
					exit;
				}
				if (($_FILES["myFile"]["type"] == "application/pkix-cert") 
					|| ($_FILES["myFile"]["type"] == "application/x-pkcs7-certificates") 
					|| ($_FILES["myFile"]["type"] == "application/octet-stream") 
					|| ($_FILES["myFile"]["type"] == "application/x-pkcs12") 
					|| ($_FILES["myFile"]["type"] == "application/x-x509-ca-cert"))
				{
					// ensure a safe filename
					$name = preg_replace("/[^A-Z0-9._-]/i", "_", $myFile["name"]);
				 
					//don't overwrite an existing file
					$i = 0;
					$parts = pathinfo($name);
					while (file_exists(UPLOAD_DIR . $name)) 
					{
						$i++;
						$name = $parts["filename"] . "-" . $i . "." . $parts["extension"];
					}
				 
					// preserve file from temporary directory
					$success = move_uploaded_file($myFile["tmp_name"],
						UPLOAD_DIR . $name);
					if (!$success) 
					{ 
						?>
						<div class="alert alert-danger col-md-offset-2 col-md-8">
							<strong>Unable to save file.</strong>
						</div>
						<?php
						exit;
					}
					else
					{
						?>
						<div class="alert alert-success col-md-offset-2 col-md-8">
							<strong>Cert has been uploaded!</strong>
							<br>
							<?php
							echo "Upload: " . $_FILES["myFile"]["name"] . "<br>";
							echo "Type: " . $_FILES["myFile"]["type"] . "<br>";
							echo "Size: " . ($_FILES["myFile"]["size"] / 1024) . " kB<br>";
							?>
						</div>
						<?php
					}
				 
					// set proper permissions on the new file
					chmod(UPLOAD_DIR . $name, 0644);
				}
				else
				{
					?>
					<div class="alert alert-danger col-md-offset-2 col-md-8">
						<strong>Not a valid cert type</strong>
					</div>
					<?php
				}
			}
		}
		?>
		</div><!-- /row panel-body  -->
	</div><!-- /pannel panel-default  -->
	</nav>
    </div> <!-- /container -->

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="../assets/js/jquery.min.js"></script>
    <script src="../assets/js/bootstrap.min.js"></script>
  </body>
</html>
